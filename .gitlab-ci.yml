default:
  image: registry.gitlab.com/mondaic/projects/sed-dug-seis/scrtdd-wrappers:latest
  tags: ["domino"]

variables:
  GIT_SUBMODULE_STRATEGY: recursive
  GIT_DEPTH: 1

stages:
  - build-cpm-cache
  - build-test

build-cpm-cache:
  stage: build-cpm-cache
  script:
    - mkdir -p /home/user/build && cd $_ && pwd && ls -a
    - cmake -S ${CI_PROJECT_DIR} -DCPM_SOURCE_CACHE:PATH=${CI_PROJECT_DIR}/.cache/cpm
  cache:
    - key: cpm
    - paths: [.cache/cpm]
    - policy: pull-push
  when: manual

.cache-config: &cache-config
  cache:
    - key: cpm
    - paths: [.cache/cpm]
    - policy: pull

.build-common: &build-common
  - mkdir -p /home/user/build && cd $_ && pwd && ls -a
  - cmake -S ${CI_PROJECT_DIR}
      --preset=${CI_JOB_NAME}
      -DCPM_SOURCE_CACHE:PATH=${CI_PROJECT_DIR}/.cache/cpm
  - cmake --build . --target hdd

gcc-12:
  stage: build-test
  script:
    - *build-common
  <<: *cache-config
  needs: []

clang-14:
  stage: build-test
  script:
    - *build-common
  <<: *cache-config
  needs: []
